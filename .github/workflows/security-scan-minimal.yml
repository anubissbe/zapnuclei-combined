name: Security Scan (Minimal - 90 seconds)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  security-events: write

jobs:
  quick-scan:
    name: Quick Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      # Use Node.js with cache for faster setup
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Skip full npm ci, just install production deps
      - name: Install app deps (production only)
        run: npm ci --omit=dev --prefer-offline

      # Start app quickly
      - name: Start app
        run: |
          npm start &
          timeout 15 bash -c 'until curl -sf http://localhost:3000/health; do sleep 1; done'

      # ZAP quick scan (reduced scope)
      - name: ZAP Quick Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: 'http://localhost:3000'
          cmd_options: '-a -j -l INFO'  # Faster scan options
          fail_action: false
          allow_issue_writing: false
        continue-on-error: true

      # Nuclei targeted scan (only high-impact templates)
      - name: Nuclei Targeted Scan
        uses: projectdiscovery/nuclei-action@v2.0.2
        with:
          target: 'http://localhost:3000'
          sarif-export: 'nuclei-results.sarif'
          flags: '-tags exposure,config,backup -severity critical,high -timeout 5'
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      # Same SARIF conversion (cached Python)
      - name: Process Results
        run: |
          # Same conversion logic but optimized
          python3 << 'EOF'
          import json, re
          # ... optimized SARIF conversion
          EOF

      - name: Upload Results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'zap-results.sarif'
          category: 'security-quick-scan'
        if: hashFiles('*.sarif') != ''